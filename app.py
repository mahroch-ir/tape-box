import streamlit as st
import pandas as pd
import os
from PIL import Image
import gspread
from google.oauth2.service_account import Credentials

# ------------------ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡ ------------------
st.set_page_config(page_title="Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§", page_icon="ğŸ§°")
st.title("ğŸ“¦ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§")

# ------------------ Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ------------------
DATA_FILE = "tools_data.csv"
IMAGES_DIR = "tool_images"
os.makedirs(IMAGES_DIR, exist_ok=True)

# ------------------ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Google Sheets ------------------
SERVICE_ACCOUNT_FILE = "service_account.json"

if os.path.exists(SERVICE_ACCOUNT_FILE):
    creds = Credentials.from_service_account_file(
        SERVICE_ACCOUNT_FILE,
        scopes=["https://www.googleapis.com/auth/spreadsheets",
                "https://www.googleapis.com/auth/drive"]
    )
else:
    st.error(f"âš ï¸ ÙØ§ÛŒÙ„ {SERVICE_ACCOUNT_FILE} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
    st.stop()

gc = gspread.authorize(creds)

# Ø§Ø³Ù… Google Sheet
SHEET_NAME = "tools_data"
try:
    sh = gc.open(SHEET_NAME)
except gspread.SpreadsheetNotFound:
    sh = gc.create(SHEET_NAME)
    sh.share(None, perm_type='anyone', role='writer')  # Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡

worksheet = sh.sheet1

# ------------------ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ------------------
records = worksheet.get_all_records()
if records:
    df = pd.DataFrame(records)
else:
    df = pd.DataFrame(columns=["Ù†Ø§Ù… Ø§Ø¨Ø²Ø§Ø±", "Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±", "Ø´Ù…Ø§Ø±Ù‡ Ù‚ÙØ³Ù‡", "Ù…Ø³ÛŒØ± Ø¹Ú©Ø³"])

# ------------------ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ ------------------
menu = st.sidebar.selectbox("Ø§Ù†ØªØ®Ø§Ø¨ ØµÙØ­Ù‡", ["â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¨Ø²Ø§Ø±", "ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§"])

# ------------------ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¨Ø²Ø§Ø± ------------------
if menu == "â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¨Ø²Ø§Ø±":
    st.header("Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¨Ø²Ø§Ø± Ø¬Ø¯ÛŒØ¯")
    name = st.selectbox("Ù†Ø§Ù… Ø§Ø¨Ø²Ø§Ø±:", ["ØªÙ¾Ù‡", "Ø¨Ù†ÙˆÚ©"])
    code = st.text_input("Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±:")
    shelf = st.number_input("Ø´Ù…Ø§Ø±Ù‡ Ù‚ÙØ³Ù‡:", min_value=1, step=1)
    image_file = st.file_uploader("ğŸ“¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ø§Ø¨Ø²Ø§Ø±", type=["jpg", "png", "jpeg"])

    if st.button("Ø°Ø®ÛŒØ±Ù‡ Ø§Ø¨Ø²Ø§Ø±"):
        if name and code and image_file:
            img_path = os.path.join(IMAGES_DIR, image_file.name)
            with open(img_path, "wb") as f:
                f.write(image_file.getbuffer())

            new_row = {
                "Ù†Ø§Ù… Ø§Ø¨Ø²Ø§Ø±": name,
                "Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±": code,
                "Ø´Ù…Ø§Ø±Ù‡ Ù‚ÙØ³Ù‡": shelf,
                "Ù…Ø³ÛŒØ± Ø¹Ú©Ø³": img_path
            }
            df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)

            # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheet
            worksheet.clear()
            worksheet.update([df.columns.values.tolist()] + df.values.tolist())

            st.success(f"âœ… Ø§Ø¨Ø²Ø§Ø± '{name}' Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!")

# ------------------ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ------------------
elif menu == "ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§":
    st.header("ğŸ“‹ Ù„ÛŒØ³Øª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§")
    if df.empty:
        st.info("Ù‡ÛŒÚ† Ø§Ø¨Ø²Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
    else:
        df["Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±"] = df["Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±"].astype(str)
        search_code = st.text_input("ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±:")

        if search_code:
            filtered_df = df[df["Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±"].str.contains(search_code, case=False, na=False)]
        else:
            filtered_df = df

        if filtered_df.empty:
            st.warning("Ù‡ÛŒÚ† Ø§Ø¨Ø²Ø§Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
        else:
            for _, row in filtered_df.iterrows():
                st.subheader(f"{row['Ù†Ø§Ù… Ø§Ø¨Ø²Ø§Ø±']} (Ú©Ø¯: {row['Ú©Ø¯ Ø§Ø¨Ø²Ø§Ø±']})")
                st.text(f"ğŸ“¦ Ù‚ÙØ³Ù‡ Ø´Ù…Ø§Ø±Ù‡: {int(row['Ø´Ù…Ø§Ø±Ù‡ Ù‚ÙØ³Ù‡'])}")
                if os.path.exists(row["Ù…Ø³ÛŒØ± Ø¹Ú©Ø³"]):
                    st.image(row["Ù…Ø³ÛŒØ± Ø¹Ú©Ø³"], width=200)
                st.markdown("---")
